# worktree-manager Design

## Inspiration
Based on the `pj` script pattern from .zshrc:
```zsh
pj() {
  local dir
  dir=$(find "$PROJECTS_DIR" -mindepth 1 -maxdepth 1 -type d | \
    fzf --height=40% --reverse --prompt="Projects> " \
        --preview 'ls -1 {} | head -n 20')

  if [[ -n $dir ]]; then
    echo "Open in Neovim? (y/N): \c"
    read -r answer
    if [[ $answer =~ ^[Yy]$ ]]; then
      nvim "$dir"
    else
      cd "$dir" || return
    fi
  fi
}
```

## Core Concept
A fuzzy-finder based git worktree manager that operates on the **current repository**. When you run `wt` from any worktree, it finds all worktrees for that repo and lets you quickly switch between them.

## Key Features

### 1. Interactive Worktree Picker (`wt`)
**Primary use case**: Run `wt` from any worktree in a repository
- Lists all worktrees for the **current repository only**
- Fuzzy finding with `fzf`
- Rich preview pane showing:
  - Repository name
  - Branch name
  - Git status (clean/dirty, ahead/behind)
  - Recent commits (last 3-5)
  - Modified files count
  - Worktree path
- Actions after selection:
  - **Enter**: Change directory to selected worktree  
  - **Ctrl-E**: Open worktree in `$EDITOR`
  - **Esc**: Cancel

### 2. Worktree Management

#### List worktrees
```bash
wt list          # List all worktrees for current repo
wt list --json   # JSON output for scripting
```

#### Create worktree
```bash
wt add <branch>                    # Create worktree for branch
wt add <branch> -p <path>          # Custom path
wt add <branch> --track <remote>   # Track remote branch
```

#### Remove worktree
```bash
wt remove <worktree>    # Remove worktree (interactive confirmation)
wt remove --force       # Skip confirmation
wt prune                # Clean up stale worktrees
```

#### Configuration
```bash
wt config ~/projects ~/work    # Configure auto-discovery search paths
```

## Technical Architecture

### Language & Tools
- **Language**: Rust (stable)
- **CLI Framework**: clap (derive API)
- **Config**: serde/serde_yaml for config.yaml
- **Fuzzy Finder**: fzf (external command)
- **Git Integration**: Shell out to git commands (no libgit2)

### Project Structure
```
src/
├── cli.rs              # Command-line interface (clap)
├── interactive.rs      # fzf-based picker
├── git.rs              # Git worktree operations
├── add.rs              # Add worktree command
├── remove.rs           # Remove worktree command
├── prune.rs            # Prune stale worktrees
├── list.rs             # List worktrees
├── agent.rs            # Agent-specific commands
├── init.rs             # Shell integration generation
├── config.rs           # Configuration management
├── discovery.rs        # Multi-repo discovery
├── worktree.rs         # Worktree data structures
├── error.rs            # Error types
├── process.rs          # Process utilities
└── main.rs             # Entry point
```

### Configuration File
Location: `~/.config/worktree-manager/config.yaml`

```yaml
version: "1.0.0"
fzf:
  height: "40%"
  layout: reverse
  preview_window: "right:60%"
auto_discovery:
  enabled: true
  paths: []
```

**Note**: Editor is configured via `$EDITOR` environment variable, not in config file.

### Shell Integration
For `cd` and editor functionality, shell wrapper is auto-generated by `wt init`:

```bash
# Setup shell integration
wt init             # Auto-detects shell and adds to config
wt init zsh         # Manual setup for zsh
wt init bash        # Manual setup for bash  
wt init fish        # Manual setup for fish

# The generated function wraps the wt binary and interprets output:
# - cd|/path -> changes directory
# - edit|/path -> opens in $EDITOR
```

## Implementation Status

All core features have been implemented:
- ✅ Git worktree discovery and management
- ✅ Interactive fzf picker with live preview
- ✅ Shell integration (cd/editor actions)
- ✅ Add/remove/prune commands
- ✅ Multi-repo auto-discovery
- ✅ Agent-friendly JSON output
- ✅ Configuration management

## Example Usage

```bash
# You're in any worktree of a repository
$ cd ~/dev/myproject  # or ~/dev/myproject-feature-x, etc.

# Interactive picker (main use case)
$ wt
# Shows fzf with all worktrees for myproject, select one → choose action

# List all worktrees for current repo
$ wt list
main       /Users/user/dev/myproject          [main] ✓ clean
feature-x  /Users/user/dev/myproject-feature  [feature-x] ✗ dirty
develop    /Users/user/dev/myproject-develop  [develop] ✓ clean

# Create new worktree
$ wt add feature-auth
Created worktree at: /Users/user/dev/myproject-feature-auth

# Remove worktree
$ wt remove feature-auth
Remove worktree 'feature-auth'? (y/N): y
Worktree removed.

# Configure auto-discovery paths
$ wt config ~/dev ~/projects
Auto-discovery paths configured.
```

## Preview Pane Format
```
┌─ Worktree Info ────────────────────────┐
│ Repo:     myproject                     │
│ Branch:   feature-auth                  │
│ Path:     ~/dev/myproject-feature-auth  │
│ Status:   2 modified, 1 untracked       │
│                                         │
│ Recent Commits:                         │
│ • abc1234 Add authentication routes     │
│ • def5678 Update user model             │
│ • ghi9012 Fix validation bug            │
│                                         │
│ Modified Files:                         │
│ • src/auth/routes.ts                    │
│ • src/models/user.ts                    │
└─────────────────────────────────────────┘
```

## Dependencies
- `clap` - CLI framework
- `serde` / `serde_yaml` - Config serialization
- `anyhow` - Error handling
- `directories` - XDG config paths
- `fzf` (external) - Fuzzy finder
- Git (external) - All git operations via shell commands

## Distribution
- Cargo package: `worktree-manager`
- Binary name: `wt`
- Shell function: `wt` (auto-generated wrapper for cd/editor integration)
